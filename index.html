<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simple Notes</title>
<style>
  :root{
    --bg:#fafbfc;--line:#e5e7eb;--muted:#6b7280;--ink:#111827;--ink-weak:#4b5563;
    --accent:#111827;--accent-ink:#fff;--danger:#dc2626;--danger-ink:#fff;
    --chip:#f3f4f6;
  }
  [data-theme="dark"]{
    --bg:#0b0f14;--line:#1f2937;--muted:#9ca3af;--ink:#e5e7eb;--ink-weak:#94a3b8;
    --accent:#3b82f6;--accent-ink:#fff;--danger:#ef4444;--danger-ink:#fff;
    --chip:#111827;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#fff0;position:sticky;top:0;backdrop-filter:saturate(180%) blur(8px);z-index:3}
  h1{margin:0;font-size:18px}
  .app{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 54px)}
  .sidebar{border-right:1px solid var(--line);background:#fff0;display:flex;flex-direction:column;min-height:0}
  .toolbar{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--line)}
  .toolbar input{flex:1;padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff0;color:var(--ink)}
  .toolbar button{padding:8px 10px;border:1px solid var(--line);background:var(--chip);border-radius:8px;cursor:pointer;color:var(--ink)}
  .list{overflow:auto}
  .item{padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .item.active{background:rgba(59,130,246,.12)}
  .item .title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .editor{padding:14px;display:flex;flex-direction:column;gap:8px}
  .path{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .path input{flex:1;min-width:220px;padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff0;color:var(--ink)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:8px 12px;border:1px solid var(--line);background:#fff0;border-radius:8px;cursor:pointer;color:var(--ink)}
  .btn.primary{background:var(--accent);color:var(--accent-ink);border-color:var(--accent)}
  .btn.danger{background:var(--danger);color:var(--danger-ink);border-color:var(--danger)}
  textarea{width:100%;height:70vh;padding:12px;border:1px solid var(--line);border-radius:10px;resize:vertical;background:#fff0;color:var(--ink)}
  .status{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;flex-wrap:wrap}
  .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px}
  
  /* Toast */
  #toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;background:#111827;color:#fff;border-radius:10px;opacity:0;pointer-events:none;transition:.3s;z-index:50}
  #toast.show{opacity:1;transform:translateY(-6px)}

  /* ëª¨ë°”ì¼ */
  @media (max-width:900px){
    .app{grid-template-columns:1fr;gap:12px;padding:8px}
    .sidebar{border-right:none;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .editor{padding:8px}
  }
</style>
</head>
<body>
<header>
  <h1>ğŸ“ Simple Notes</h1>
  <div>
    <button id="themeBtn" class="btn" title="ë‹¤í¬ëª¨ë“œ í† ê¸€">ğŸŒ“</button>
  </div>
</header>

<div class="app">
  <aside class="sidebar">
    <div class="toolbar">
      <input id="searchNotes" placeholder="ë©”ëª¨ ê²€ìƒ‰..."/>
      <button id="newNote" class="btn" title="ìƒˆ ë©”ëª¨ (Ctrl/Cmd+N)">+</button>
    </div>
    <div id="list" class="list"></div>
  </aside>

  <main class="editor">
    <div class="path">
      <input id="filename" placeholder="ê²½ë¡œ (ì˜ˆ: notes/idea.md)"/>
      <div class="actions">
        <button id="loadBtn" class="btn" title="ë¶ˆëŸ¬ì˜¤ê¸°">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="saveBtn" class="btn primary" title="ì €ì¥ (Ctrl/Cmd+S)">ì €ì¥</button>
        <button id="deleteBtn" class="btn danger" title="ì‚­ì œ">ì‚­ì œ</button>
        <span id="saveState" class="badge">ëŒ€ê¸°</span>
      </div>
    </div>

    <textarea id="editor" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>

    <div class="status">
      <span>Repository: <strong>notes</strong></span>
      <span id="info"></span>
    </div>
  </main>
</div>

<div id="toast"></div>

<script>
(function(){
  /* ===== ì„¤ì • ===== */
  const API = 'https://notes-api.rusilhurpe.workers.dev'; // â˜… Worker ì£¼ì†Œ ìœ ì§€

  /* ===== DOM Elements ===== */
  const listEl = document.getElementById('list');
  const filenameEl = document.getElementById('filename');
  const editorEl = document.getElementById('editor');
  const loadBtn = document.getElementById('loadBtn');
  const saveBtn = document.getElementById('saveBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const saveState = document.getElementById('saveState');
  const info = document.getElementById('info');
  const themeBtn = document.getElementById('themeBtn');
  const searchNotes = document.getElementById('searchNotes');
  const newNoteBtn = document.getElementById('newNote');

  /* ===== State ===== */
  let currentPath = '';
  let sha = null;
  let cacheList = [];
  let dirty = false;

  /* ===== Theme Init ===== */
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
  themeBtn.onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', cur);
    localStorage.setItem('theme', cur);
  };

  /* ===== Helper: Title Extraction ===== */
  const titleCache = new Map();
  function fallbackTitle(path){ const base = path.split('/').pop().replace(/\.md$/i,''); return base.replace(/[-_]+/g,' '); }
  
  async function getTitle(path){
    if (titleCache.has(path)) return titleCache.get(path);
    try{
      const r = await fetch(`${API}/load?path=${encodeURIComponent(path)}`);
      if(!r.ok){ const t=fallbackTitle(path); titleCache.set(path,t); return t; }
      const {content} = await r.json();
      let title = '';
      if(content){
        const lines = content.split(/\r?\n/);
        const h = lines.find(l=>/^#\s+/.test(l));
        title = h ? h.replace(/^#\s+/,'').trim() : (lines.find(l=>l.trim())||'').trim();
      }
      if(!title) title = fallbackTitle(path);
      if(title.length>80) title = title.slice(0,80)+'â€¦';
      titleCache.set(path,title);
      return title;
    }catch{
      const t=fallbackTitle(path); titleCache.set(path,t); return t;
    }
  }

  function updateTitleCacheFromEditor(path){
    const line = editorEl.value.split(/\r?\n/).find(l=>/^#\s+/.test(l));
    const title = (line ? line.replace(/^#\s+/, '').trim() : '') || titleCache.get(path) || fallbackTitle(path);
    titleCache.set(path, title);
  }

  /* ===== List Logic ===== */
  async function loadList(){
    // ì¼ê¸° ëª¨ë“œê°€ ì—†ìœ¼ë¯€ë¡œ ë¬´ì¡°ê±´ 'notes' í´ë”ë§Œ ì¡°íšŒ
    const res = await fetch(`${API}/list?dir=notes`);
    if(!res.ok){ listEl.innerHTML=`<div class="item">ëª©ë¡ ì‹¤íŒ¨ ${res.status}</div>`; return; }
    cacheList = await res.json();
    renderList();
  }

  function renderList(){
    const q = (searchNotes.value||'').toLowerCase();
    listEl.innerHTML='';
    
    // ë©”ëª¨ëŠ” ìµœì‹ ìˆœ(ì´ë¦„ ì—­ìˆœ) ì •ë ¬ì´ ì¼ë°˜ì 
    let items = cacheList.slice().sort((a,b)=> b.name.localeCompare(a.name));

    if(items.length===0){
      listEl.innerHTML = `<div class="item">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    for(const it of items){
      const el = document.createElement('div');
      el.className = 'item' + (it.path===currentPath?' active':'');
      el.innerHTML = `<div class="title">...</div>`;
      el.onclick = () => {
        if(dirty && !confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        filenameEl.value = it.path; 
        doLoad(it.path);
      };
      listEl.appendChild(el);
      
      getTitle(it.path).then(title=>{
        if(q && !title.toLowerCase().includes(q)){ el.remove(); return; }
        el.querySelector('.title').textContent = title;
      });
    }
  }
  searchNotes.addEventListener('input', renderList);

  /* ===== File Operations ===== */
  function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

  async function doLoad(path){
    if(!path) return;
    info.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    const res = await fetch(`${API}/load?path=${encodeURIComponent(path)}`);
    if(!res.ok){ info.textContent='ì‹¤íŒ¨'; toast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); return; }
    
    const json = await res.json();
    editorEl.value = json.content || '';
    sha = json.sha || null;
    currentPath = path;
    dirty = false;
    saveState.textContent='ë¶ˆëŸ¬ì˜´';
    
    updateTitleCacheFromEditor(path);
    loadList(); // í™œì„±í™” ìƒíƒœ ê°±ì‹  ë“±ì„ ìœ„í•´
  }

  async function doSave(){
    const path = filenameEl.value.trim();
    if(!path){ alert('íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: notes/ì œëª©.md)'); return; }
    
    saveState.textContent='ì €ì¥ ì¤‘...';
    const res = await fetch(`${API}/save`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ path, content: editorEl.value, sha })
    });
    
    if(!res.ok){ saveState.textContent='ì‹¤íŒ¨'; toast('ì €ì¥ ì‹¤íŒ¨'); return; }
    const json = await res.json();
    sha = json.sha || sha;
    dirty = false;
    saveState.textContent='ì €ì¥ë¨';
    info.textContent = `ì €ì¥: ${new Date().toLocaleTimeString()}`;
    
    updateTitleCacheFromEditor(path);
    // ëª©ë¡ ê°±ì‹  (ìƒˆ íŒŒì¼ì¼ ê²½ìš° ëª©ë¡ì— ì¶”ê°€ë˜ì–´ì•¼ í•˜ë¯€ë¡œ)
    if(!cacheList.some(x=>x.path===path)) loadList(); else renderList();
    toast('ì €ì¥ ì™„ë£Œ');
  }

  async function doDelete(){
    const path = filenameEl.value.trim();
    if(!path || !sha) return;
    if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const res = await fetch(`${API}/delete`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ path, sha })
    });
    
    if(!res.ok){ toast('ì‚­ì œ ì‹¤íŒ¨'); return; }
    
    editorEl.value = '';
    filenameEl.value = '';
    sha = null; currentPath = '';
    saveState.textContent='ëŒ€ê¸°';
    toast('ì‚­ì œ ì™„ë£Œ');
    loadList();
  }

  /* ===== New Note ===== */
  function newNote(){
    if(dirty && !confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë¬´ì‹œí•˜ê³  ìƒˆ ë©”ëª¨ë¥¼ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const now=new Date();
    // íŒŒì¼ëª… í¬ë§·: notes/YYYY-MM-DD_HHMM.md
    const name = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.md`;
    const path = `notes/${name}`;
    
    filenameEl.value = path; 
    currentPath = path; 
    sha = null;
    editorEl.value = `# ${name.replace('.md','')}\n\n`;
    dirty = true; 
    saveState.textContent='ìƒˆê¸€';
    
    titleCache.set(path, name.replace('.md',''));
    renderList();
    editorEl.focus();
  }
  newNoteBtn.onclick = newNote;

  /* ===== Listeners ===== */
  loadBtn.onclick = ()=> doLoad(filenameEl.value.trim());
  saveBtn.onclick = doSave;
  deleteBtn.onclick = doDelete;
  
  editorEl.addEventListener('input', ()=>{ dirty=true; saveState.textContent='ìˆ˜ì •ë¨'; });
  window.addEventListener('beforeunload', (e)=>{ if(dirty){ e.preventDefault(); e.returnValue=''; } });

  document.addEventListener('keydown', (e)=>{
    const mod = e.metaKey || e.ctrlKey;
    if(mod && e.key.toLowerCase()==='s'){ e.preventDefault(); doSave(); }
    if(mod && e.key.toLowerCase()==='n'){ e.preventDefault(); newNote(); }
  });

  /* ===== Init ===== */
  loadList();
  // ì‹œì‘ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ë°›ì€ í¸ì§€í•¨(inbox) ê°™ì€ ê±¸ ë„ìš°ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
  // doLoad('notes/inbox.md'); 
})();
</script>
</body>
</html>
