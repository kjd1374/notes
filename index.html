<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My GitHub Notes</title>
<style>
  :root{ --bg:#fafbfc;--line:#e5e7eb;--muted:#6b7280;--ink:#111827;--chip:#f3f4f6;--accent:#111827; }
  [data-theme="dark"]{ --bg:#0b0f14;--line:#1f2937;--muted:#9ca3af;--ink:#e5e7eb;--chip:#111827;--accent:#3b82f6; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,sans-serif;height:100vh;overflow:hidden;}
  
  .app{display:grid;grid-template-columns:300px 1fr;height:100%;}
  
  /* ì‚¬ì´ë“œë°” */
  .sidebar{border-right:1px solid var(--line);display:flex;flex-direction:column;background:var(--bg);}
  .header{padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;}
  .header h1{font-size:18px;margin:0;}
  .search-box{padding:10px;border-bottom:1px solid var(--line);display:flex;gap:5px;}
  .search-box input{flex:1;padding:6px;border-radius:6px;border:1px solid var(--line);background:var(--bg);color:var(--ink);}
  .list{flex:1;overflow-y:auto;}
  .item{padding:12px 16px;border-bottom:1px solid var(--line);cursor:pointer;}
  .item:hover{background:var(--chip);}
  .item.active{background:rgba(59,130,246,0.1);border-left:3px solid var(--accent);}
  .item .t{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .item .d{font-size:11px;color:var(--muted);margin-top:2px;}

  /* ì—ë””í„° ì˜ì—­ */
  .main{display:flex;flex-direction:column;height:100%;}
  .toolbar{padding:10px 20px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;}
  .status{font-size:12px;color:var(--muted);font-family:monospace;}
  .editor-area{flex:1;padding:30px 40px;display:flex;flex-direction:column;overflow-y:auto;}
  
  #noteTitle{ font-size:28px;font-weight:bold;border:none;background:transparent;color:var(--ink);width:100%;outline:none;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid transparent; }
  #noteTitle:focus{ border-bottom-color:var(--line); }
  #editor{ flex:1;border:none;resize:none;background:transparent;color:var(--ink);font-size:16px;line-height:1.6;outline:none;font-family:inherit; }
  
  button{cursor:pointer;padding:6px 12px;border-radius:6px;border:1px solid var(--line);background:var(--chip);color:var(--ink);}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
  
  @media(max-width:700px){ .app{grid-template-columns:1fr;} .sidebar{display:none;} }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="header">
      <h1>ğŸ“’ GitHub Notes</h1>
      <button id="themeBtn">ğŸŒ“</button>
    </div>
    <div class="search-box">
      <input id="search" placeholder="ê²€ìƒ‰...">
      <button id="newBtn">+</button>
    </div>
    <div id="list" class="list"></div>
  </aside>
  <main class="main">
    <div class="toolbar">
      <span id="filePath" class="status">ì¤€ë¹„ë¨</span>
      <div style="display:flex;gap:8px">
        <button id="saveBtn" class="primary">ì €ì¥</button>
        <button id="delBtn">ì‚­ì œ</button>
      </div>
    </div>
    <div class="editor-area">
      <input id="noteTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
      <textarea id="editor" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>
  </main>
</div>
<script>
(function(){
  /* â˜…â˜…â˜… ì—¬ê¸°ê°€ ì œì¼ ì¤‘ìš”í•©ë‹ˆë‹¤!!! â˜…â˜…â˜… 
     Cloudflare Worker ì£¼ì†Œë¥¼ ë”°ì˜´í‘œ ì•ˆì— ì •í™•íˆ ë„£ì–´ì£¼ì„¸ìš”.
     (ì˜ˆ: https://notes-api.rusilhurpe.workers.dev)
  */
  const API = 'https://notes-api.rusilhurpe.workers.dev'; 

  const listEl = document.getElementById('list');
  const titleEl = document.getElementById('noteTitle');
  const editorEl = document.getElementById('editor');
  const pathEl = document.getElementById('filePath');
  const searchEl = document.getElementById('search');
  
  let currentPath = '';
  let sha = null;
  let cacheList = [];
  let dirty = false;
  
  const titleMap = {};

  if(localStorage.getItem('theme')==='dark') document.documentElement.setAttribute('data-theme','dark');
  document.getElementById('themeBtn').onclick = () => {
    const isDark = document.documentElement.getAttribute('data-theme')==='dark';
    document.documentElement.setAttribute('data-theme', isDark?'light':'dark');
    localStorage.setItem('theme', isDark?'light':'dark');
  };

  function makeFilename(){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds())+'.md';
  }

  function rawTitle(path){ return path.split('/').pop().replace('.md',''); }

  async function loadList(){
    try {
      // API ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ê²½ê³ 
      if(!API) { alert('index.html ì½”ë“œ ì•ˆì˜ API ì£¼ì†Œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!'); return; }

      const res = await fetch(API + '/list?dir=notes');
      if(res.ok) {
        const items = await res.json();
        cacheList = items.sort((a,b) => b.name.localeCompare(a.name));
        renderList();
        cacheList.forEach(item => fetchTitle(item.path));
      }
    } catch(e) { console.error(e); }
  }

  function renderList(){
    const q = (searchEl.value||'').toLowerCase();
    listEl.innerHTML = '';
    cacheList.forEach(item => {
      const displayTitle = titleMap[item.path] || rawTitle(item.path);
      if(q && !displayTitle.toLowerCase().includes(q)) return;
      
      const div = document.createElement('div');
      div.className = 'item' + (item.path === currentPath ? ' active' : '');
      div.innerHTML = '<div class="t">' + displayTitle + '</div><div class="d">' + item.name.split('_')[0] + '</div>';
      div.onclick = () => {
        if(dirty && !confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        loadFile(item.path);
      };
      listEl.appendChild(div);
    });
  }
  searchEl.oninput = renderList;

  async function fetchTitle(path){
    if(titleMap[path]) return;
    try {
      const res = await fetch(API + '/load?path=' + encodeURIComponent(path));
      if(res.ok){
        const json = await res.json();
        const content = json.content || '';
        const m = content.match(/^#\\s+(.*)/);
        if(m) {
          titleMap[path] = m[1].trim();
          renderList();
        }
      }
    } catch(e){}
  }

  async function loadFile(path){
    pathEl.textContent = 'ë¡œë”© ì¤‘...';
    try {
      const res = await fetch(API + '/load?path=' + encodeURIComponent(path));
      if(!res.ok) throw new Error('Load failed');
      const json = await res.json();
      currentPath = path;
      sha = json.sha;
      const content = json.content || '';
      const lines = content.split('\\n');
      if(lines.length > 0 && lines[0].startsWith('# ')) {
        titleEl.value = lines[0].substring(2).trim();
      } else {
        titleEl.value = rawTitle(path);
      }
      editorEl.value = content; 
      pathEl.textContent = path;
      dirty = false;
      renderList();
    } catch(e) {
      alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      pathEl.textContent = 'ì˜¤ë¥˜';
    }
  }

  async function saveFile(){
    if(!currentPath) return;
    pathEl.textContent = 'ì €ì¥ ì¤‘...';
    const realTitle = titleEl.value.trim() || 'ë¬´ì œ';
    let lines = editorEl.value.split('\\n');
    if(lines.length > 0 && lines[0].startsWith('# ')) {
      lines[0] = '# ' + realTitle;
    } else {
      lines.unshift('# ' + realTitle);
    }
    const newContent = lines.join('\\n');

    try {
      const res = await fetch(API + '/save', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ path: currentPath, content: newContent, sha: sha })
      });
      if(!res.ok) throw new Error('Save failed');
      const json = await res.json();
      sha = json.sha;
      dirty = false;
      pathEl.textContent = 'ì €ì¥ë¨';
      titleMap[currentPath] = realTitle;
      const exists = cacheList.find(x => x.path === currentPath);
      if(!exists) loadList(); else renderList();
    } catch(e) {
      alert('ì €ì¥ ì‹¤íŒ¨');
      pathEl.textContent = 'ì‹¤íŒ¨';
    }
  }

  async function deleteFile(){
    if(!currentPath || !confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      await fetch(API + '/delete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ path: currentPath, sha: sha })
      });
      titleEl.value = ''; editorEl.value = ''; currentPath = ''; sha = null;
      pathEl.textContent = 'ì‚­ì œë¨';
      loadList();
    } catch(e) { alert('ì‚­ì œ ì‹¤íŒ¨'); }
  }

  document.getElementById('newBtn').onclick = () => {
    if(dirty && !confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ë²„ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const name = makeFilename();
    currentPath = 'notes/' + name;
    sha = null;
    titleEl.value = '';
    editorEl.value = '# \\n\\n';
    pathEl.textContent = 'ìƒˆ ë©”ëª¨ (' + name + ')';
    titleEl.focus();
    dirty = true;
  };

  document.getElementById('saveBtn').onclick = saveFile;
  document.getElementById('delBtn').onclick = deleteFile;
  
  titleEl.addEventListener('input', () => {
    dirty = true;
    if(currentPath) {
      titleMap[currentPath] = titleEl.value;
      const activeItem = listEl.querySelector('.item.active .t');
      if(activeItem) activeItem.textContent = titleEl.value || 'ë¬´ì œ';
    }
  });
  
  editorEl.addEventListener('input', () => dirty = true);
  window.addEventListener('keydown', e => {
    if((e.ctrlKey||e.metaKey) && e.key === 's') { e.preventDefault(); saveFile(); }
  });

  loadList();
})();
</script>
</body>
</html>
