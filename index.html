<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Notes + Diary</title>
<style>
  :root{--bg:#fafbfc;--line:#e5e7eb;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:18px}
  .tabs{display:flex;gap:8px}
  .tab{padding:6px 12px;border:1px solid var(--line);border-bottom:none;border-radius:8px 8px 0 0;background:#f6f7fb;cursor:pointer}
  .tab.active{background:#fff;font-weight:600}
  .subbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;color:var(--muted)}
  .app{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 54px)}
  .sidebar{border-right:1px solid var(--line);background:#fff;display:flex;flex-direction:column;min-height:0}
  .toolbar{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--line)}
  .toolbar input{flex:1;padding:8px;border:1px solid var(--line);border-radius:8px}
  .toolbar button{padding:8px 10px;border:1px solid var(--line);background:#f8f9fb;border-radius:8px;cursor:pointer}
  .list{overflow:auto}
  .item{padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .item.active{background:#eef2ff}
  .item small{display:block;color:var(--muted)}
  .editor{padding:14px;display:flex;flex-direction:column;gap:8px}
  .path{display:flex;gap:8px;align-items:center}
  .path input{flex:1;padding:8px;border:1px solid var(--line);border-radius:8px}
  textarea{width:100%;height:60vh;padding:12px;border:1px solid var(--line);border-radius:10px;resize:vertical;background:#fff}
  .status{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;flex-wrap:wrap}
  .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .meta select,.meta input{padding:8px;border:1px solid var(--line);border-radius:8px}
  @media (max-width:900px){ .app{grid-template-columns:1fr} .sidebar{display:none} }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px;">
    <h1>ğŸ“ Notes + ğŸ“” Diary</h1>
    <div class="tabs">
      <div id="tabNotes" class="tab active">ë©”ëª¨</div>
      <div id="tabDiary" class="tab">ì¼ê¸°</div>
    </div>
  </div>
  <div class="subbar">
    <div id="dateBar" style="display:none;align-items:center;gap:6px;">
      <button id="prevDay">â†</button>
      <input id="datePicker" type="date"/>
      <button id="nextDay">â†’</button>
    </div>
    <div id="today"></div>
  </div>
</header>

<div class="app">
  <aside class="sidebar">
    <div class="toolbar" id="toolsNotes">
      <input id="searchNotes" placeholder="ë©”ëª¨ ê²€ìƒ‰(íŒŒì¼ëª…)"/>
      <button id="newNote">ìƒˆ ë…¸íŠ¸</button>
    </div>
    <div class="toolbar" id="toolsDiary" style="display:none;">
      <input id="searchDiary" placeholder="ì´ ë‹¬ì˜ ì¼ê¸° ê²€ìƒ‰(íŒŒì¼ëª…)"/>
    </div>
    <div id="list" class="list"></div>
  </aside>

  <main class="editor">
    <div class="path">
      <input id="filename"/>
      <button id="loadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span id="saveState" class="badge">ëŒ€ê¸°</span>
    </div>

    <div id="metaDiary" class="meta" style="display:none;">
      <select id="mood">
        <option value="">ê¸°ë¶„</option>
        <option>ğŸ˜Š í–‰ë³µ</option><option>ğŸ˜Œ í¸ì•ˆ</option><option>ğŸ˜¥ ìš°ìš¸</option>
        <option>ğŸ˜¡ í™”ë‚¨</option><option>ğŸ˜µ í”¼ê³¤</option><option>ğŸ¤© ì‹ ë‚¨</option>
      </select>
      <select id="weather">
        <option value="">ë‚ ì”¨</option>
        <option>â˜€ï¸ ë§‘ìŒ</option><option>â›… ë¶€ë¶„ë§‘ìŒ</option><option>ğŸŒ§ï¸ ë¹„</option>
        <option>â›ˆï¸ ë‡Œìš°</option><option>ğŸŒ¨ï¸ ëˆˆ</option><option>ğŸŒ«ï¸ ì•ˆê°œ</option>
      </select>
      <input id="tags" placeholder="#íƒœê·¸,ì‰¼í‘œë¡œ êµ¬ë¶„"/>
    </div>

    <textarea id="editor" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (ìë™ ì €ì¥)"></textarea>

    <div class="status">
      <span>ë¦¬í¬ì§€í† ë¦¬: <strong>kjd1374/notes</strong> | ë¸Œëœì¹˜: <strong>main</strong></span>
      <span id="info"></span>
    </div>
  </main>
</div>

<script>
(function(){
  // â˜… ë³¸ì¸ Worker ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš”
  const API = 'https://notes-api.rusilhurpe.workers.dev';

  // === ê³µí†µ ===
  const listEl = document.getElementById('list');
  const filenameEl = document.getElementById('filename');
  const editorEl = document.getElementById('editor');
  const loadBtn = document.getElementById('loadBtn');
  const saveState = document.getElementById('saveState');
  const info = document.getElementById('info');
  const todayEl = document.getElementById('today');

  const tabNotes = document.getElementById('tabNotes');
  const tabDiary = document.getElementById('tabDiary');
  const toolsNotes = document.getElementById('toolsNotes');
  const toolsDiary = document.getElementById('toolsDiary');

  const searchNotes = document.getElementById('searchNotes');
  const searchDiary = document.getElementById('searchDiary');
  const newNoteBtn = document.getElementById('newNote');

  const dateBar = document.getElementById('dateBar');
  const picker = document.getElementById('datePicker');
  const prevBtn = document.getElementById('prevDay');
  const nextBtn = document.getElementById('nextDay');

  const metaDiary = document.getElementById('metaDiary');
  const moodEl = document.getElementById('mood');
  const weatherEl = document.getElementById('weather');
  const tagsEl = document.getElementById('tags');

  let mode = 'notes'; // 'notes' | 'diary'
  let currentPath = '';
  let sha = null, dirty=false, saving=false, timer=null;
  let cacheList = [];
  let currentDate = new Date();

  // ë‚ ì§œ/ê²½ë¡œ ìœ í‹¸ (Diary)
  const fmt = (d)=> d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const monthDir = (d)=> `diary/${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}`;
  const toDiaryPath = (d)=> `${monthDir(d)}/${String(d.getDate()).padStart(2,'0')}.md`;
  const pathToDate = (p)=>{ const m=p.match(/(\d{4})\/(\d{2})\/(\d{2})\.md$/); return m? new Date(+m[1],+m[2]-1,+m[3]) : new Date(); };

  // ì˜¤ëŠ˜ í‘œì‹œ
  const d = new Date();
  todayEl.textContent = fmt(d);
  picker.valueAsDate = currentDate;

  // ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadList(){
    const dir = mode==='notes' ? 'notes' : monthDir(currentDate);
    const res = await fetch(`${API}/list?dir=${encodeURIComponent(dir)}`);
    if(!res.ok){ listEl.innerHTML=`<div class="item">ëª©ë¡ ì‹¤íŒ¨ ${res.status}</div>`; return; }
    const arr = await res.json();
    cacheList = arr;
    renderList();
  }

  function renderList(){
    const q = (mode==='notes' ? (searchNotes.value||'') : (searchDiary.value||'')).toLowerCase();
    listEl.innerHTML='';
    let items = cacheList.filter(x => x.name.toLowerCase().includes(q));
    items.sort((a,b)=> (mode==='notes' ? b.name.localeCompare(a.name) : a.name.localeCompare(b.name)));
    if(items.length===0){ listEl.innerHTML = `<div class="item">${mode==='notes'?'ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤':'ì´ ë‹¬ì˜ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤'}</div>`; return; }
    for(const it of items){
      const el=document.createElement('div');
      el.className='item'+(it.path===currentPath?' active':'');
      if(mode==='notes'){
        el.innerHTML=`<div>${it.name}</div><small>${it.path}</small>`;
        el.onclick=()=> { filenameEl.value = it.path; loadFile(it.path); };
      }else{
        const day = it.name.replace('.md','');
        el.innerHTML=`<div>${day}ì¼</div><small>${it.path}</small>`;
        el.onclick=()=> openDiary(pathToDate(it.path));
      }
      listEl.appendChild(el);
    }
  }
  searchNotes.addEventListener('input', renderList);
  searchDiary.addEventListener('input', renderList);

  // íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
  loadBtn.onclick = () => loadFile(filenameEl.value.trim());
  async function loadFile(path){
    if(!path) return;
    info.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    const res = await fetch(`${API}/load?path=${encodeURIComponent(path)}`);
    if(!res.ok){ info.textContent=`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ${res.status}`; return; }
    const json = await res.json();
    editorEl.value = json.content || '';
    sha = json.sha || null;
    currentPath = path;
    dirty=false; saveState.textContent='ë¶ˆëŸ¬ì˜´';
    if(mode==='diary'){ // front-matterë¥¼ ë©”íƒ€ë¡œ ë°˜ì˜
      const c = editorEl.value;
      moodEl.value    = c.match(/mood:\s*(.*)/)?.[1]?.trim() || '';
      weatherEl.value = c.match(/weather:\s*(.*)/)?.[1]?.trim() || '';
      tagsEl.value    = c.match(/tags:\s*(.*)/)?.[1]?.trim() || '';
    }
    loadList(); // ëª©ë¡ ê°±ì‹ 
  }

  // ìë™ ì €ì¥
  editorEl.addEventListener('input', ()=>{ dirty=true; saveSoon(); });
  function saveSoon(immediate=false){
    if(timer) clearTimeout(timer);
    timer = setTimeout(saveNow, immediate?0:1200);
  }
  async function saveNow(){
    if(saving || !dirty) return;
    const path = filenameEl.value.trim();
    if(!path) return;
    saving = true; saveState.textContent='ì €ì¥ ì¤‘...';
    const res = await fetch(`${API}/save`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ path, content: editorEl.value, sha })
    });
    if(!res.ok){ saveState.textContent=`ì €ì¥ ì‹¤íŒ¨ ${res.status}`; saving=false; return; }
    const json = await res.json();
    sha = json.sha || sha;
    dirty=false; saving=false; saveState.textContent='ì €ì¥ë¨';
    info.textContent = `ì €ì¥: ${new Date().toLocaleTimeString()}`;
    // ìƒˆ íŒŒì¼ì´ë©´ ëª©ë¡ ê°±ì‹ 
    if(!cacheList.some(x=>x.path===path)) loadList();
  }

  // ë©”ëª¨ ëª¨ë“œ: ìƒˆ ë…¸íŠ¸
  newNoteBtn.onclick = ()=>{
    const now=new Date();
    const name = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.md`;
    const path = `notes/${name}`;
    filenameEl.value = path; currentPath=path; sha=null;
    editorEl.value = `# ${name.replace('.md','')}\n\n`;
    dirty=true; saveSoon(true);
  };

  // ì¼ê¸° ëª¨ë“œ: ë‚ ì§œ ì´ë™/ì—´ê¸°
  function diaryTemplate(date){
    const ymd = fmt(date);
    return `---
date: ${ymd}
mood: ${moodEl.value||''}
weather: ${weatherEl.value||''}
tags: ${tagsEl.value||''}
---

# ${ymd} ì¼ê¸°

ì˜¤ëŠ˜ì˜ í•œ ì¤„:
- 

ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼:
- 

ê°ì •/ìƒê°:
- 
`;
  }
  async function openDiary(date){
    currentDate = date;
    picker.valueAsDate = date;
    const path = toDiaryPath(date);
    filenameEl.value = path; currentPath = path;
    const res = await fetch(`${API}/load?path=${encodeURIComponent(path)}`);
    if(!res.ok){ info.textContent=`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ${res.status}`; return; }
    const {content, sha:shaVal} = await res.json();
    sha=shaVal||null;
    if(!content){
      editorEl.value = diaryTemplate(date);
      dirty=true; saveSoon(true);
    }else{
      editorEl.value = content;
      dirty=false; saveState.textContent='ë¶ˆëŸ¬ì˜´';
      const c = content;
      moodEl.value    = c.match(/mood:\s*(.*)/)?.[1]?.trim() || '';
      weatherEl.value = c.match(/weather:\s*(.*)/)?.[1]?.trim() || '';
      tagsEl.value    = c.match(/tags:\s*(.*)/)?.[1]?.trim() || '';
    }
    loadList();
  }
  prevBtn.onclick = ()=> openDiary(new Date(currentDate.getFullYear(),currentDate.getMonth(),currentDate.getDate()-1));
  nextBtn.onclick = ()=> openDiary(new Date(currentDate.getFullYear(),currentDate.getMonth(),currentDate.getDate()+1));
  picker.onchange   = ()=> openDiary(new Date(picker.value));
  [moodEl,weatherEl,tagsEl].forEach(el=> el.addEventListener('change', ()=>{
    let t=editorEl.value;
    t = /mood:\s*.*/.test(t)    ? t.replace(/mood:\s*.*/,'mood: '+(moodEl.value||''))       : t;
    t = /weather:\s*.*/.test(t) ? t.replace(/weather:\s*.*/,'weather: '+(weatherEl.value||'')) : t;
    if(/tags:\s*.*/.test(t)) t = t.replace(/tags:\s*.*/,'tags: '+(tagsEl.value||''));
    else t = t.replace(/---\n\n/,'---\n\ntags: '+(tagsEl.value||'')+'\n\n');
    editorEl.value = t; dirty=true; saveSoon();
  }));

  // íƒ­ ì „í™˜
  function switchTab(next){
    mode = next;
    // íƒ­ UI
    tabNotes.classList.toggle('active', mode==='notes');
    tabDiary.classList.toggle('active', mode==='diary');
    toolsNotes.style.display = (mode==='notes')?'flex':'none';
    toolsDiary.style.display = (mode==='diary')?'flex':'none';
    dateBar.style.display    = (mode==='diary')?'flex':'none';
    metaDiary.style.display  = (mode==='diary')?'flex':'none';

    if(mode==='notes'){
      filenameEl.value = 'notes/inbox.md';
      loadList();
      loadFile('notes/inbox.md');
    }else{
      openDiary(currentDate);
    }
  }
  tabNotes.onclick = ()=> switchTab('notes');
  tabDiary.onclick = ()=> switchTab('diary');

  // ì‹œì‘: ë©”ëª¨ ëª¨ë“œ ê¸°ë³¸
  switchTab('notes');
})();
</script>
</body>
</html>
