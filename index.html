<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Notes</title>
<style>
  :root{--bg:#fafbfc;--line:#e5e7eb;--muted:#6b7280;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:1}
  h1{margin:0;font-size:18px}
  #date{font-weight:600}
  .app{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 54px)}
  .sidebar{border-right:1px solid var(--line);background:#fff;display:flex;flex-direction:column;min-height:0}
  .toolbar{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--line)}
  .toolbar input{flex:1;padding:8px;border:1px solid var(--line);border-radius:8px}
  .toolbar button{padding:8px 10px;border:1px solid var(--line);background:#f8f9fb;border-radius:8px;cursor:pointer}
  .list{overflow:auto}
  .item{padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .item.active{background:#eef2ff}
  .item small{display:block;color:var(--muted)}
  .editor{padding:14px;display:flex;flex-direction:column;gap:8px}
  .path{display:flex;gap:8px;align-items:center}
  .path input{flex:1;padding:8px;border:1px solid var(--line);border-radius:8px}
  textarea{width:100%;height:65vh;padding:12px;border:1px solid var(--line);border-radius:10px;resize:vertical;background:#fff}
  .status{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
  .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px}
  @media (max-width:900px){ .app{grid-template-columns:1fr} .sidebar{display:none} }
</style>
</head>
<body>
<header>
  <h1>ğŸ“ My Notes</h1>
  <div id="date"></div>
</header>

<div class="app">
  <aside class="sidebar">
    <div class="toolbar">
      <input id="search" placeholder="ê²€ìƒ‰(íŒŒì¼ëª…)"/>
      <button id="newBtn">ìƒˆ ë…¸íŠ¸</button>
    </div>
    <div id="list" class="list"></div>
  </aside>

  <main class="editor">
    <div class="path">
      <input id="filename" value="notes/inbox.md"/>
      <button id="loadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span id="saveState" class="badge">ëŒ€ê¸°</span>
    </div>
    <textarea id="editor" placeholder="ì—¬ê¸°ì— ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ìë™ ì €ì¥)"></textarea>
    <div class="status">
      <span>ë¦¬í¬ì§€í† ë¦¬: <strong>kjd1374/notes</strong> | ë¸Œëœì¹˜: <strong>main</strong></span>
      <span id="info"></span>
    </div>
  </main>
</div>

<script>
(function(){
  // â† ë³¸ì¸ Worker ì£¼ì†Œ
  const API = 'https://notes-api.rusilhurpe.workers.dev';
  const NOTES_DIR = 'notes';

  // ë‚ ì§œ í‘œì‹œ
  const d = new Date();
  document.getElementById('date').textContent =
    d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');

  const listEl = document.getElementById('list');
  const searchEl = document.getElementById('search');
  const newBtn = document.getElementById('newBtn');
  const filenameEl = document.getElementById('filename');
  const loadBtn = document.getElementById('loadBtn');
  const editorEl = document.getElementById('editor');
  const saveState = document.getElementById('saveState');
  const info = document.getElementById('info');

  let sha = null;
  let currentPath = '';
  let dirty = false;
  let saving = false;
  let timer = null;
  let cacheList = [];

  // ----- ì‚¬ì´ë“œë°” ëª©ë¡ -----
  async function loadList() {
    const res = await fetch(`${API}/list?dir=${encodeURIComponent(NOTES_DIR)}`);
    if (!res.ok) { listEl.innerHTML = `<div class="item">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (${res.status})</div>`; return; }
    cacheList = await res.json(); // [{name,path},...]
    renderList();
  }
  function renderList() {
    const q = (searchEl.value||'').trim().toLowerCase();
    listEl.innerHTML = '';
    const items = cacheList.filter(x => x.name.toLowerCase().includes(q));
    if (items.length===0) {
      listEl.innerHTML = `<div class="item">ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
      return;
    }
    for (const it of items) {
      const el = document.createElement('div');
      el.className = 'item' + (it.path===currentPath ? ' active':'');
      el.innerHTML = `<div>${it.name}</div><small>${it.path}</small>`;
      el.onclick = ()=> { filenameEl.value = it.path; loadFile(it.path); };
      listEl.appendChild(el);
    }
  }
  searchEl.addEventListener('input', renderList);

  // ----- ìƒˆ ë…¸íŠ¸ -----
  newBtn.onclick = () => {
    const now = new Date();
    const name = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.md`;
    const path = `${NOTES_DIR}/${name}`;
    filenameEl.value = path;
    editorEl.value = `# ${name.replace('.md','')}\n\n`;
    sha = null; currentPath = path; dirty = true; saveSoon(true);
    setActive(path);
  };

  function setActive(path){
    currentPath = path;
    // active í‘œì‹œ ê°±ì‹ 
    [...document.querySelectorAll('.item')].forEach(el => {
      if (el.querySelector('small')) el.classList.toggle('active', el.querySelector('small').textContent===path);
    });
  }

  // ----- íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° -----
  loadBtn.onclick = () => loadFile(filenameEl.value.trim());
  async function loadFile(path){
    if (!path) return;
    info.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    const res = await fetch(`${API}/load?path=${encodeURIComponent(path)}`);
    if (!res.ok) { info.textContent = `ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ${res.status}`; saveState.textContent='ì‹¤íŒ¨'; return; }
    const json = await res.json();
    editorEl.value = json.content || '';
    sha = json.sha || null;
    dirty = false;
    saveState.textContent = 'ë¶ˆëŸ¬ì˜´';
    info.textContent = path;
    setActive(path);
    // ëª©ë¡ ìµœì‹ í™”(ì²˜ìŒ ìƒì„±ëœ íŒŒì¼ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
    loadList();
  }

  // ----- ìë™ ì €ì¥ -----
  editorEl.addEventListener('input', ()=>{ dirty=true; saveSoon(); });
  function saveSoon(immediate=false){
    if (timer) clearTimeout(timer);
    timer = setTimeout(saveNow, immediate ? 0 : 1200);
  }
  async function saveNow(){
    if (saving || !dirty) return;
    const path = filenameEl.value.trim();
    if (!path) return;
    saving = true; saveState.textContent = 'ì €ì¥ ì¤‘...';
    const res = await fetch(`${API}/save`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ path, content: editorEl.value, sha })
    });
    if (!res.ok) {
      saveState.textContent = `ì €ì¥ ì‹¤íŒ¨ ${res.status}`;
      saving = false;
      return;
    }
    const json = await res.json();
    sha = json.sha || sha;
    dirty = false; saving = false;
    saveState.textContent = 'ì €ì¥ë¨';
    info.textContent = `ì €ì¥: ${new Date().toLocaleTimeString()}`;
    // ëª©ë¡ì— ì—†ë˜ ìƒˆ íŒŒì¼ì´ë©´ ë‹¤ì‹œ ëª©ë¡ ê°±ì‹ 
    if (!cacheList.some(x => x.path === path)) loadList();
  }

  // ì´ˆê¸° êµ¬ë™
  (async ()=>{
    document.getElementById('filename').value = `${NOTES_DIR}/inbox.md`;
    await loadList();
    await loadFile(`${NOTES_DIR}/inbox.md`);
  })();
})();
</script>
</body>
</html>
