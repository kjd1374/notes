<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>My Notes</title>
<style>
  :root{ 
    --bg:#ffffff; --line:#e2e8f0; --muted:#64748b; --ink:#0f172a; 
    --chip:#f1f5f9; --accent:#0f172a; --danger:#ef4444;
  }
  [data-theme="dark"]{ 
    --bg:#0f172a; --line:#1e293b; --muted:#94a3b8; --ink:#f8fafc; 
    --chip:#1e293b; --accent:#3b82f6; 
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    height:100vh; overflow:hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
  }
  
  /* ì•± ì „ì²´ ë ˆì´ì•„ì›ƒ */
  .app{ display:flex; height:100%; width:100%; position:relative; }
  
  /* --- ì‚¬ì´ë“œë°” (ëª©ë¡) --- */
  .sidebar{
    width:300px; border-right:1px solid var(--line); display:flex; flex-direction:column; background:var(--bg);
    flex-shrink:0; z-index:2;
  }
  .header{
    padding:12px 16px; border-bottom:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center;
  }
  .header h1{ font-size:18px; font-weight:700; margin:0; }
  
  .search-box{ padding:10px; border-bottom:1px solid var(--line); display:flex; gap:8px; }
  .search-box input{
    flex:1; padding:8px; border-radius:8px; border:1px solid var(--line);
    background:var(--chip); color:var(--ink); outline:none; font-size:14px;
  }
  .search-box button{
    width:36px; font-size:20px; padding:0; display:flex; align-items:center; justify-content:center;
  }

  .list{ flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }
  .item{ padding:14px 16px; border-bottom:1px solid var(--line); cursor:pointer; }
  .item:active{ background:var(--chip); }
  .item.active{ background:var(--chip); border-left:4px solid var(--accent); }
  .item .t{ font-weight:600; font-size:15px; margin-bottom:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .item .d{ font-size:12px; color:var(--muted); }

  /* --- ë©”ì¸ (ì—ë””í„°) --- */
  .main{
    flex:1; display:flex; flex-direction:column; background:var(--bg);
    min-width:0; /* flex ìì‹ overflow ë°©ì§€ */
  }
  
  /* íˆ´ë°” */
  .toolbar{
    padding:8px 12px; border-bottom:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center; height:50px;
  }
  .toolbar-left{ display:flex; align-items:center; gap:8px; overflow:hidden; }
  #backBtn{ display:none; /* ë°ìŠ¤í¬íƒ‘ì—ì„  ìˆ¨ê¹€ */ font-weight:bold; }
  .status{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  
  .actions{ display:flex; gap:8px; }
  
  /* ì—ë””í„° ì˜ì—­ */
  .editor-area{
    flex:1; display:flex; flex-direction:column; padding:20px;
    overflow-y:auto; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
  }
  
  #noteTitle{
    font-size:22px; font-weight:700; border:none; background:transparent;
    color:var(--ink); width:100%; outline:none; margin-bottom:16px;
    padding:0 0 8px 0; border-bottom:2px solid transparent;
  }
  #noteTitle:focus{ border-bottom-color:var(--line); }
  
  #editor{
    flex:1; border:none; resize:none; background:transparent;
    color:var(--ink); font-size:16px; line-height:1.6; outline:none;
    font-family:inherit; width:100%; min-height:50vh; /* ìµœì†Œ ë†’ì´ í™•ë³´ */
  }

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  button{
    padding:6px 12px; border-radius:8px; border:1px solid var(--line);
    background:var(--bg); color:var(--ink); cursor:pointer; font-size:13px;
  }
  button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  button.danger{ color:var(--danger); border-color:var(--line); }

  /* --- â˜… ëª¨ë°”ì¼ ë°˜ì‘í˜• ì²˜ë¦¬ â˜… --- */
  @media (max-width: 768px) {
    /* ê¸°ë³¸ ìƒíƒœ: ëª©ë¡ë§Œ ë³´ì„ */
    .app .main { display:none; }
    .sidebar { width:100%; }
    
    /* ì—ë””í„° í™œì„± ìƒíƒœ (í´ë˜ìŠ¤ show-editor) */
    .app.show-editor .sidebar { display:none; }
    .app.show-editor .main { display:flex; }
    
    #backBtn { display:block; } /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í‘œì‹œ */
    
    .editor-area { padding:16px; } /* íŒ¨ë”© ì¶•ì†Œ */
    #noteTitle { font-size:20px; }
    #editor { font-size:15px; }
  }
</style>
</head>
<body>

<div id="app" class="app">
  <aside class="sidebar">
    <div class="header">
      <h1>ğŸ“’ Notes</h1>
      <button id="themeBtn">ğŸŒ“</button>
    </div>
    <div class="search-box">
      <input id="search" placeholder="ê²€ìƒ‰...">
      <button id="newBtn" title="ìƒˆ ë©”ëª¨">+</button>
    </div>
    <div id="list" class="list"></div>
  </aside>

  <main class="main">
    <div class="toolbar">
      <div class="toolbar-left">
        <button id="backBtn">â† ëª©ë¡</button>
        <span id="filePath" class="status">ì¤€ë¹„ë¨</span>
      </div>
      <div class="actions">
        <button id="delBtn" class="danger">ì‚­ì œ</button>
        <button id="saveBtn" class="primary">ì €ì¥</button>
      </div>
    </div>
    <div class="editor-area">
      <input id="noteTitle" placeholder="ì œëª© ì…ë ¥">
      <textarea id="editor" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    </div>
  </main>
</div>

<script>
(function(){
  /* âš ï¸ ì—¬ê¸°ì— Cloudflare Worker ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”! */
  const API = 'https://notes-api.rusilhurpe.workers.dev';

  /* DOM */
  const appEl = document.getElementById('app');
  const listEl = document.getElementById('list');
  const titleEl = document.getElementById('noteTitle');
  const editorEl = document.getElementById('editor');
  const pathEl = document.getElementById('filePath');
  const searchEl = document.getElementById('search');
  
  let currentPath = '';
  let sha = null;
  let cacheList = [];
  let dirty = false;
  const titleMap = {};

  /* ëª¨ë°”ì¼ í™”ë©´ ì „í™˜ í•¨ìˆ˜ */
  function showList() { appEl.classList.remove('show-editor'); }
  function showEditor() { appEl.classList.add('show-editor'); }
  document.getElementById('backBtn').onclick = () => {
    if(dirty && !confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    showList();
  };

  /* í…Œë§ˆ ì„¤ì • */
  if(localStorage.getItem('theme')==='dark') document.documentElement.setAttribute('data-theme','dark');
  document.getElementById('themeBtn').onclick = () => {
    const isDark = document.documentElement.getAttribute('data-theme')==='dark';
    document.documentElement.setAttribute('data-theme', isDark?'light':'dark');
    localStorage.setItem('theme', isDark?'light':'dark');
  };

  /* ìœ í‹¸ */
  function makeFilename(){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds())+'.md';
  }
  function rawTitle(path){ return path.split('/').pop().replace('.md',''); }

  /* ëª©ë¡ ë¡œë“œ */
  async function loadList(){
    if(!API){ alert('API ì£¼ì†Œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!'); return; }
    try {
      const res = await fetch(API + '/list?dir=notes');
      if(res.ok) {
        const items = await res.json();
        cacheList = items.sort((a,b) => b.name.localeCompare(a.name));
        renderList();
        cacheList.forEach(item => fetchTitle(item.path));
      }
    } catch(e) { console.error(e); }
  }

  function renderList(){
    const q = (searchEl.value||'').toLowerCase();
    listEl.innerHTML = '';
    
    if(cacheList.length === 0) {
      listEl.innerHTML = '<div style="padding:20px;text-align:center;color:#aaa">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }

    cacheList.forEach(item => {
      const displayTitle = titleMap[item.path] || rawTitle(item.path);
      if(q && !displayTitle.toLowerCase().includes(q)) return;
      
      const div = document.createElement('div');
      div.className = 'item' + (item.path === currentPath ? ' active' : '');
      div.innerHTML = `<div class="t">${displayTitle}</div><div class="d">${item.name.split('_')[0]}</div>`;
      div.onclick = () => {
        if(dirty && !confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        loadFile(item.path);
      };
      listEl.appendChild(div);
    });
  }
  searchEl.oninput = renderList;

  /* ì œëª© ë¹„ë™ê¸° ë¡œë“œ */
  async function fetchTitle(path){
    if(titleMap[path]) return;
    try {
      const res = await fetch(API + '/load?path=' + encodeURIComponent(path));
      if(res.ok){
        const json = await res.json();
        const content = json.content || '';
        const m = content.match(/^#\s+(.*)/);
        if(m) { titleMap[path] = m[1].trim(); renderList(); }
      }
    } catch(e){}
  }

  /* íŒŒì¼ ì—´ê¸° */
  async function loadFile(path){
    pathEl.textContent = 'ë¡œë”© ì¤‘...';
    showEditor(); // ëª¨ë°”ì¼: ì—ë””í„° í™”ë©´ìœ¼ë¡œ ì „í™˜
    
    try {
      const res = await fetch(API + '/load?path=' + encodeURIComponent(path));
      if(!res.ok) throw new Error('Load failed');
      const json = await res.json();
      currentPath = path;
      sha = json.sha;
      
      const content = json.content || '';
      const lines = content.split('\n');
      if(lines.length > 0 && lines[0].startsWith('# ')) {
        titleEl.value = lines[0].substring(2).trim();
      } else {
        titleEl.value = rawTitle(path);
      }
      editorEl.value = content; 
      pathEl.textContent = path;
      dirty = false;
      
      // í™œì„± ì•„ì´í…œ í‘œì‹œ
      document.querySelectorAll('.item').forEach(el => el.classList.remove('active'));
      renderList(); 
    } catch(e) {
      alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      pathEl.textContent = 'ì˜¤ë¥˜';
    }
  }

  /* íŒŒì¼ ì €ì¥ */
  async function saveFile(){
    if(!currentPath) return;
    pathEl.textContent = 'ì €ì¥ ì¤‘...';
    const realTitle = titleEl.value.trim() || 'ë¬´ì œ';
    let lines = editorEl.value.split('\n');
    if(lines.length > 0 && lines[0].startsWith('# ')) {
      lines[0] = '# ' + realTitle;
    } else {
      lines.unshift('# ' + realTitle);
    }
    const newContent = lines.join('\n');

    try {
      const res = await fetch(API + '/save', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ path: currentPath, content: newContent, sha: sha })
      });
      if(!res.ok) throw new Error('Save failed');
      const json = await res.json();
      sha = json.sha;
      dirty = false;
      pathEl.textContent = 'ì €ì¥ë¨';
      titleMap[currentPath] = realTitle;
      
      // ëª©ë¡ ê°±ì‹ 
      const exists = cacheList.find(x => x.path === currentPath);
      if(!exists) loadList(); else renderList();
      
    } catch(e) {
      alert('ì €ì¥ ì‹¤íŒ¨');
      pathEl.textContent = 'ì‹¤íŒ¨';
    }
  }

  /* íŒŒì¼ ì‚­ì œ */
  async function deleteFile(){
    if(!currentPath || !confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      await fetch(API + '/delete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ path: currentPath, sha: sha })
      });
      titleEl.value = ''; editorEl.value = ''; currentPath = ''; sha = null;
      pathEl.textContent = 'ì‚­ì œë¨';
      loadList();
      showList(); // ëª¨ë°”ì¼: ëª©ë¡ìœ¼ë¡œ ë³µê·€
    } catch(e) { alert('ì‚­ì œ ì‹¤íŒ¨'); }
  }

  /* ìƒˆ ë©”ëª¨ */
  document.getElementById('newBtn').onclick = () => {
    if(dirty && !confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ë²„ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const name = makeFilename();
    currentPath = 'notes/' + name;
    sha = null;
    titleEl.value = '';
    editorEl.value = '# \n\n';
    pathEl.textContent = 'ìƒˆ ë©”ëª¨';
    
    showEditor(); // ëª¨ë°”ì¼: ì—ë””í„°ë¡œ ì´ë™
    setTimeout(() => titleEl.focus(), 100); // í¬ì»¤ìŠ¤ íƒ€ì´ë° ì¡°ì ˆ
    dirty = true;
  };

  document.getElementById('saveBtn').onclick = saveFile;
  document.getElementById('delBtn').onclick = deleteFile;
  
  /* ì‹¤ì‹œê°„ ì œëª© ë°˜ì˜ */
  titleEl.addEventListener('input', () => {
    dirty = true;
    if(currentPath) {
      titleMap[currentPath] = titleEl.value;
      // í™œì„± ì•„ì´í…œ ì—…ë°ì´íŠ¸ëŠ” renderList ì¬í˜¸ì¶œ ì—†ì´ DOMë§Œ ìˆ˜ì • (ì„±ëŠ¥)
      const activeEl = Array.from(document.querySelectorAll('.item')).find(el => el.textContent.includes(rawTitle(currentPath))); 
      if(activeEl) { renderList(); } // ê°„ë‹¨íˆ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }
  });
  
  editorEl.addEventListener('input', () => dirty = true);
  window.addEventListener('keydown', e => {
    if((e.ctrlKey||e.metaKey) && e.key === 's') { e.preventDefault(); saveFile(); }
  });

  /* ì´ˆê¸°í™” */
  loadList();
})();
</script>
</body>
</html>
