<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Diary</title>
<style>
  :root{--bg:#fafbfc;--line:#e5e7eb;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:1}
  h1{margin:0;font-size:18px}
  .datebar{display:flex;gap:8px;align-items:center}
  .datebar button{padding:6px 10px;border:1px solid var(--line);background:#f8f9fb;border-radius:8px;cursor:pointer}
  .app{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 54px)}
  .sidebar{border-right:1px solid var(--line);background:#fff;display:flex;flex-direction:column;min-height:0}
  .toolbar{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--line)}
  .toolbar input{flex:1;padding:8px;border:1px solid var(--line);border-radius:8px}
  .list{overflow:auto}
  .item{padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .item.active{background:#eef2ff}
  .item small{display:block;color:var(--muted)}
  .editor{padding:14px;display:flex;flex-direction:column;gap:8px}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .meta select,.meta input{padding:8px;border:1px solid var(--line);border-radius:8px}
  .path{font-size:12px;color:var(--muted)}
  textarea{width:100%;height:60vh;padding:12px;border:1px solid var(--line);border-radius:10px;resize:vertical;background:#fff}
  .status{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
  .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px}
  @media (max-width:900px){ .app{grid-template-columns:1fr} .sidebar{display:none} }
</style>
</head>
<body>
<header>
  <h1>ğŸ“” My Diary</h1>
  <div class="datebar">
    <button id="prevDay">â†</button>
    <input id="datePicker" type="date"/>
    <button id="nextDay">â†’</button>
  </div>
</header>

<div class="app">
  <aside class="sidebar">
    <div class="toolbar">
      <input id="search" placeholder="ì´ ë‹¬ì˜ ì¼ê¸° ê²€ìƒ‰(íŒŒì¼ëª…)"/>
    </div>
    <div id="list" class="list"></div>
  </aside>

  <main class="editor">
    <div class="meta">
      <select id="mood">
        <option value="">ê¸°ë¶„</option>
        <option>ğŸ˜Š í–‰ë³µ</option><option>ğŸ˜Œ í¸ì•ˆ</option><option>ğŸ˜¥ ìš°ìš¸</option>
        <option>ğŸ˜¡ í™”ë‚¨</option><option>ğŸ˜µ í”¼ê³¤</option><option>ğŸ¤© ì‹ ë‚¨</option>
      </select>
      <select id="weather">
        <option value="">ë‚ ì”¨</option>
        <option>â˜€ï¸ ë§‘ìŒ</option><option>â›… ë¶€ë¶„ë§‘ìŒ</option><option>ğŸŒ§ï¸ ë¹„</option>
        <option>â›ˆï¸ ë‡Œìš°</option><option>ğŸŒ¨ï¸ ëˆˆ</option><option>ğŸŒ«ï¸ ì•ˆê°œ</option>
      </select>
      <input id="tags" placeholder="#íƒœê·¸,ì‰¼í‘œë¡œ êµ¬ë¶„"/>
      <span id="saveState" class="badge">ëŒ€ê¸°</span>
    </div>

    <div class="path" id="pathLabel"></div>
    <textarea id="editor" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê¸°ë¡í•´ ë³´ì„¸ìš”. (ìë™ ì €ì¥)"></textarea>
    <div class="status">
      <span>ë¦¬í¬ì§€í† ë¦¬: <strong>kjd1374/notes</strong> | ë¸Œëœì¹˜: <strong>main</strong></span>
      <span id="info"></span>
    </div>
  </main>
</div>

<script>
(function(){
  // â˜… ë³¸ì¸ Worker ì£¼ì†Œë¡œ ë³€ê²½
  const API = 'https://notes-api.rusilhurpe.workers.dev';
  const DIARY_DIR = 'diary';

  // ë‚ ì§œ ìœ í‹¸
  const fmt = (d)=> d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const toPath = (d)=> `${DIARY_DIR}/${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}.md`;
  const monthDir = (d)=> `${DIARY_DIR}/${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}`;

  // DOM
  const picker = document.getElementById('datePicker');
  const prevBtn = document.getElementById('prevDay');
  const nextBtn = document.getElementById('nextDay');
  const listEl = document.getElementById('list');
  const searchEl = document.getElementById('search');
  const moodEl = document.getElementById('mood');
  const weatherEl = document.getElementById('weather');
  const tagsEl = document.getElementById('tags');
  const editorEl = document.getElementById('editor');
  const info = document.getElementById('info');
  const pathLabel = document.getElementById('pathLabel');
  const saveState = document.getElementById('saveState');

  let currentDate = new Date();
  let currentPath = '';
  let sha = null, dirty=false, saving=false, timer=null;
  let cacheList=[];

  // ì´ˆê¸° ë‚ ì§œ
  picker.valueAsDate = currentDate;

  // ëª©ë¡ ë¡œë“œ (í•´ë‹¹ ì›”)
  async function loadList(d){
    const dir = monthDir(d);
    const res = await fetch(`${API}/list?dir=${encodeURIComponent(dir)}`);
    if (!res.ok){ listEl.innerHTML = `<div class="item">ëª©ë¡ ì‹¤íŒ¨ ${res.status}</div>`; return; }
    const arr = await res.json(); // í˜„ ë‹¬ì˜ íŒŒì¼ë“¤ë§Œ
    cacheList = arr.map(x=>({name:x.name, path:x.path}));
    renderList();
  }
  function renderList(){
    const q=(searchEl.value||'').toLowerCase();
    listEl.innerHTML='';
    const items = cacheList.filter(x=>x.name.toLowerCase().includes(q))
      .sort((a,b)=>a.name.localeCompare(b.name)); // 01.md..31.md
    if(items.length===0){ listEl.innerHTML = `<div class="item">ì´ ë‹¬ì˜ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</div>`; return; }
    for(const it of items){
      const el=document.createElement('div');
      el.className='item'+(it.path===currentPath?' active':'');
      const day = it.name.replace('.md','');
      el.innerHTML=`<div>${day}ì¼</div><small>${it.path}</small>`;
      el.onclick=()=> openDate(pathToDate(it.path));
      listEl.appendChild(el);
    }
  }
  searchEl.addEventListener('input', renderList);

  // ê²½ë¡œâ†’ë‚ ì§œ
  function pathToDate(path){
    const m = path.match(/(\d{4})\/(\d{2})\/(\d{2})\.md$/);
    if(!m) return new Date();
    return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
  }

  // ì¼ê¸° í…œí”Œë¦¿
  function templateFor(date){
    const ymd = fmt(date);
    return `---
date: ${ymd}
mood: ${moodEl.value||''}
weather: ${weatherEl.value||''}
tags: ${tagsEl.value||''}
---

# ${ymd} ì¼ê¸°

ì˜¤ëŠ˜ì˜ í•œ ì¤„:
- 

ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼:
- 

ê°ì •/ìƒê°:
- 
`;
  }

  // íŒŒì¼ ì—´ê¸°
  async function openDate(date){
    currentDate = date;
    picker.valueAsDate = date;
    currentPath = toPath(date);
    pathLabel.textContent = currentPath;
    info.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'; saveState.textContent='ëŒ€ê¸°';
    const res = await fetch(`${API}/load?path=${encodeURIComponent(currentPath)}`);
    if(!res.ok){ info.textContent=`ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ ${res.status}`; return; }
    const {content, sha:shaVal} = await res.json();
    sha = shaVal || null;
    if(!content){
      editorEl.value = templateFor(date); // ìƒˆ íŒŒì¼ í…œí”Œë¦¿
      dirty = true; saveSoon(true);      // ì¦‰ì‹œ ìƒì„± ì €ì¥
    }else{
      editorEl.value = content;
      dirty=false; saveState.textContent='ë¶ˆëŸ¬ì˜´';
    }
    // ì›” ëª©ë¡ ê°±ì‹ 
    loadList(date);
    // ë©”íƒ€ ìë™ ì¶”ì¶œ (front matter ëŒ€ì¶© íŒŒì‹±)
    const mMood = content?.match(/mood:\s*(.*)/)?.[1]?.trim(); if(mMood) moodEl.value=mMood;
    const mWea  = content?.match(/weather:\s*(.*)/)?.[1]?.trim(); if(mWea) weatherEl.value=mWea;
    const mTags = content?.match(/tags:\s*(.*)/)?.[1]?.trim(); if(mTags) tagsEl.value=mTags;
  }

  // ì €ì¥
  editorEl.addEventListener('input', ()=>{ dirty=true; saveSoon(); });
  [moodEl,weatherEl,tagsEl].forEach(el=> el.addEventListener('change', ()=>{
    // front-matter ê°±ì‹ (ìˆìœ¼ë©´ ë°”ê¾¸ê³ , ì—†ìœ¼ë©´ ì¶”ê°€)
    let t=editorEl.value;
    t = t.replace(/mood:\s*.*/,'mood: '+(moodEl.value||''));
    t = t.replace(/weather:\s*.*/,'weather: '+(weatherEl.value||''));
    if(/tags:\s*.*/.test(t)) t=t.replace(/tags:\s*.*/,'tags: '+(tagsEl.value||''));
    else t=t.replace(/---\n\n/,'---\n\ntags: '+(tagsEl.value||'')+'\n\n');
    editorEl.value=t; dirty=true; saveSoon();
  }));

  function saveSoon(immediate=false){
    if(timer) clearTimeout(timer);
    timer = setTimeout(saveNow, immediate?0:1200);
  }
  async function saveNow(){
    if(saving || !dirty) return;
    saving = true; saveState.textContent='ì €ì¥ ì¤‘...';
    const res = await fetch(`${API}/save`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ path: currentPath, content: editorEl.value, sha })
    });
    if(!res.ok){ saveState.textContent=`ì‹¤íŒ¨ ${res.status}`; saving=false; return; }
    const json = await res.json();
    sha = json.sha || sha;
    dirty=false; saving=false; saveState.textContent='ì €ì¥ë¨';
    info.textContent = `ì €ì¥: ${new Date().toLocaleTimeString()}`;
    // ëª©ë¡ì— ì—†ë˜ ìƒˆ íŒŒì¼ì´ë©´ ì›” ëª©ë¡ ê°±ì‹ 
    if(!cacheList.some(x=>x.path===currentPath)) loadList(currentDate);
  }

  // ë‚ ì§œ ì´ë™
  prevBtn.onclick = ()=> openDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()-1));
  nextBtn.onclick = ()=> openDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()+1));
  picker.onchange   = ()=> openDate(new Date(picker.value));

  // ì‹œì‘
  openDate(currentDate);
})();
</script>
</body>
</html>
