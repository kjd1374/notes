<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Notes</title>
<style>
  body{max-width:900px;margin:24px auto;padding:0 16px;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,button,textarea{font:inherit}
  input,textarea{width:100%;box-sizing:border-box}
  .row{display:flex;gap:8px;align-items:center}
  .row>*{flex:1}
  textarea{height:60vh;padding:12px;border:1px solid #ddd;border-radius:8px}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ccc}
  .ok{border-color:#5cb85c}.warn{border-color:#f0ad4e}.err{border-color:#d9534f}
  footer{margin-top:8px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1 style="margin:0;">ğŸ“ My Notes</h1>
  <span id="status" class="badge warn">ì¤€ë¹„</span>
</header>

<div class="row" style="margin-top:8px;">
  <input id="filename" placeholder="íŒŒì¼ ê²½ë¡œ (ì˜ˆ: inbox.md ë˜ëŠ” notes/today.md)" value="inbox.md"/>
  <button id="loadBtn" style="flex:0 0 auto;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
</div>

<textarea id="editor" placeholder="ì—¬ê¸°ì— ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ìë™ ì €ì¥)"></textarea>

<footer>
  <div>ë¦¬í¬ì§€í† ë¦¬: <strong>kjd1374/notes</strong> | ë¸Œëœì¹˜: <strong>main</strong></div>
  <div id="info"></div>
</footer>

<script>
(function(){
  // === ì—¬ê¸°ë§Œ ë³¸ì¸ Worker ì£¼ì†Œë¡œ ë°”ê¾¸ì„¸ìš” ===
  const API = 'https://notes-api.rusilhurpe.workers.dev';

  const status = document.getElementById('status');
  const info = document.getElementById('info');
  const editor = document.getElementById('editor');
  const filenameInput = document.getElementById('filename');
  const loadBtn = document.getElementById('loadBtn');

  let currentPath = '';
  let currentSHA = null;
  let dirty = false;
  let saving = false;
  let saveTimer = null;

  loadBtn.onclick = () => loadFile(filenameInput.value.trim());
  editor.addEventListener('input', ()=>{ dirty = true; scheduleSave(); });

  function setOK(msg){ status.className='badge ok'; status.textContent=msg; }
  function setWarn(msg){ status.className='badge warn'; status.textContent=msg; }
  function setErr(msg){ status.className='badge err'; status.textContent=msg; }

  async function loadFile(path){
    if(!path) return alert('íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    info.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    currentPath = path; currentSHA = null; dirty = false;

    const res = await fetch(`${API}/load?path=${encodeURIComponent(path)}`);
    if(res.status===404){
      editor.value=''; currentSHA=null; info.textContent='ìƒˆ íŒŒì¼'; scheduleSave(true); return;
    }
    if(!res.ok){ setErr('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); info.textContent = (res.status+' '+res.statusText); return; }
    const json = await res.json();
    editor.value = json.content || '';
    currentSHA = json.sha || null;
    info.textContent = 'ë¶ˆëŸ¬ì˜´: ' + path;
    setOK('ì¤€ë¹„ë¨');
  }

  function scheduleSave(immediate=false){
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveNow, immediate? 0 : 1200);
  }

  async function saveNow(){
    if(saving || !dirty || !currentPath) return;
    saving = true; setWarn('ì €ì¥ ì¤‘...');
    const res = await fetch(`${API}/save`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ path: currentPath, content: editor.value, sha: currentSHA })
    });
    if(!res.ok){ setErr('ì €ì¥ ì‹¤íŒ¨'); info.textContent = (res.status+' '+(await res.text())); saving=false; return; }
    const json = await res.json();
    currentSHA = json.sha || currentSHA;
    dirty = false; saving = false; setOK('ì €ì¥ë¨');
    info.textContent = `ì €ì¥ ì™„ë£Œ: ${new Date().toLocaleTimeString()}`;
  }

  window.addEventListener('load', ()=>{
    const initial = filenameInput.value.trim();
    if(initial) loadFile(initial);
  });
})();
</script>
</body>
</html>
