<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Notes</title>
<style>
  body{max-width:900px;margin:24px auto;padding:0 16px;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,button,textarea{font:inherit}
  input,textarea{width:100%;box-sizing:border-box}
  .row{display:flex;gap:8px;align-items:center}
  .row>*{flex:1}
  textarea{height:60vh;padding:12px;border:1px solid #ddd;border-radius:8px}
  .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ccc}
  .ok{border-color:#5cb85c}
  .warn{border-color:#f0ad4e}
  .err{border-color:#d9534f}
  footer{margin-top:8px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1 style="margin:0;">ğŸ“ My Notes</h1>
  <span id="status" class="badge warn">í† í° í•„ìš”</span>
</header>

<div class="row" style="margin-top:12px;">
  <input id="token" type="password" placeholder="GitHub Personal Access Token (ë¸Œë¼ìš°ì € ì„¸ì…˜ì—ë§Œ ì €ì¥)" />
  <button id="saveToken" style="flex:0 0 auto;">ì‚¬ìš©</button>
</div>

<div class="row" style="margin-top:8px;">
  <input id="filename" placeholder="íŒŒì¼ ê²½ë¡œ (ì˜ˆ: inbox.md ë˜ëŠ” notes/today.md)" value="inbox.md" />
  <button id="loadBtn" style="flex:0 0 auto;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
</div>

<textarea id="editor" placeholder="ì—¬ê¸°ì— ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ìˆ˜ì • ì‹œ ìë™ ì €ì¥)"></textarea>

<footer>
  <div>
    ë¦¬í¬ì§€í† ë¦¬: <strong id="repoLabel"></strong>
    &nbsp;|&nbsp; ë¸Œëœì¹˜: <strong>main</strong>
  </div>
  <div id="info"></div>
</footer>

<script>
(function(){
  // === ì„¤ì •: ë³¸ì¸ GitHub ì‚¬ìš©ìëª…ê³¼ ë¦¬í¬ ì´ë¦„ ===
  const owner = location.hostname.includes('.github.io')
                  ? location.hostname.split('.github.io')[0]
                  : 'kjd1374'; // ì˜ˆ: 'kjd1374'
  const repo  = 'notes';
  document.getElementById('repoLabel').textContent = owner + '/' + repo;

  // === ìƒíƒœ ===
  const status = document.getElementById('status');
  const info = document.getElementById('info');
  const editor = document.getElementById('editor');
  const filenameInput = document.getElementById('filename');
  const tokenInput = document.getElementById('token');
  const saveTokenBtn = document.getElementById('saveToken');
  const loadBtn = document.getElementById('loadBtn');

  let token = sessionStorage.getItem('gh_token') || '';
  let currentPath = '';
  let currentSHA = null;
  let dirty = false;
  let saving = false;
  let saveTimer = null;

  if(token){ tokenInput.value = token; setOK('í† í° ì„¤ì •ë¨'); } else { setWarn('í† í° í•„ìš”'); }

  saveTokenBtn.onclick = () => {
    token = tokenInput.value.trim();
    sessionStorage.setItem('gh_token', token);
    setOK('í† í° ì„¤ì •ë¨');
  };

  loadBtn.onclick = () => {
    loadFile(filenameInput.value.trim());
  };

  editor.addEventListener('input', () => {
    dirty = true;
    scheduleSave();
  });

  function setOK(msg){ status.className='badge ok'; status.textContent=msg; }
  function setWarn(msg){ status.className='badge warn'; status.textContent=msg; }
  function setErr(msg){ status.className='badge err'; status.textContent=msg; }

  function b64encode(str){
    return btoa(unescape(encodeURIComponent(str)));
  }
  function b64decode(b64){
    return decodeURIComponent(escape(atob(b64)));
  }

  async function loadFile(path){
    if(!token){ setWarn('í† í° í•„ìš”'); return alert('ë¨¼ì € í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.'); }
    if(!path) return alert('íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    info.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    currentPath = path;
    currentSHA = null;
    dirty = false;

    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}`, Accept: 'application/vnd.github+json' }});
    if(res.status===404){
      editor.value = '';
      currentSHA = null;
      info.textContent = 'ìƒˆ íŒŒì¼ (ì•„ì§ ì—†ìŒ)';
      scheduleSave(true); // ë°”ë¡œ ìƒì„±
      return;
    }
    if(!res.ok){
      setErr('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); info.textContent = (res.status+' '+res.statusText);
      return;
    }
    const json = await res.json();
    currentSHA = json.sha;
    editor.value = json.content ? b64decode(json.content) : '';
    info.textContent = 'ë¶ˆëŸ¬ì˜´: ' + path;
    setOK('ì¤€ë¹„ë¨');
  }

  function scheduleSave(immediate=false){
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveNow, immediate? 0 : 1200); // íƒ€ì´í•‘ ë©ˆì¶˜ ë’¤ 1.2ì´ˆ í›„ ì €ì¥
  }

  async function saveNow(){
    if(saving || !dirty) return;
    if(!token || !currentPath){ return; }
    saving = true;
    setWarn('ì €ì¥ ì¤‘...');
    const content = b64encode(editor.value);
    const body = {
      message: `chore(notes): auto-save ${currentPath}`,
      content,
      branch: 'main'
    };
    if(currentSHA) body.sha = currentSHA;

    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(currentPath)}`;
    const res = await fetch(url, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if(!res.ok){
      setErr('ì €ì¥ ì‹¤íŒ¨'); info.textContent = (res.status+' '+res.statusText);
      saving = false;
      return;
    }
    const json = await res.json();
    currentSHA = json.content && json.content.sha ? json.content.sha : currentSHA;
    dirty = false;
    saving = false;
    setOK('ì €ì¥ë¨');
    info.textContent = `ì €ì¥ ì™„ë£Œ: ${new Date().toLocaleTimeString()}`;
  }

  // ì²« ë¡œë“œ ì‹œ ê¸°ë³¸ íŒŒì¼
  window.addEventListener('load', ()=> {
    const initial = filenameInput.value.trim();
    if(initial) loadFile(initial);
  });
})();
</script>
</body>
</html>

